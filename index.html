<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<div id="env-widget" style="
  font-family: 'Inter', Arial, sans-serif;
  padding: 15px;
  border-radius: 10px;
  background: #c99d6c;
  color: #00072d;
  max-width: 350px;
  width: 100%;
  box-sizing: border-box;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
">
  <h3 id="env-city" style="
    margin:0 0 10px;
    font-size: 1em;
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  " title="Loading...">Loading...</h3>
  
  <!-- AQI Section -->
  <div style="margin-bottom: 15px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
      <p id="env-aqi" style="margin:0; font-size:2em; font-weight:bold;">--</p>
      <p id="env-aqi-level" style="
        margin:0;
        font-size:0.85em;
        padding:6px 12px;
        border-radius:20px;
        font-weight:600;
        white-space: nowrap;
      ">--</p>
    </div>
    <!-- Visual Scale Bar -->
    <div id="aqi-scale" style="
      height: 8px;
      background: linear-gradient(to right, #00e400 0%, #00e400 16.67%, #ffff00 16.67%, #ffff00 33.33%, #ff7e00 33.33%, #ff7e00 50%, #ff0000 50%, #ff0000 66.67%, #8f3f97 66.67%, #8f3f97 83.33%, #7e0023 83.33%, #7e0023 100%);
      border-radius: 4px;
      position: relative;
      margin-bottom: 5px;
    ">
      <div id="aqi-indicator" style="
        position: absolute;
        width: 4px;
        height: 16px;
        background: #00072d;
        top: -4px;
        border-radius: 2px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        transition: left 0.3s ease;
      "></div>
    </div>
    <div style="display: flex; justify-content: space-between; font-size: 0.65em; opacity: 0.8; margin-top: 2px;">
      <span>0</span>
      <span>300+</span>
    </div>
  </div>
  
  <!-- UV Section -->
  <div style="margin-bottom: 10px;">
    <p id="env-uv" style="margin:0 0 5px; font-size:1.5em; font-weight:bold;">UV: --</p>
    <div id="uv-scale" style="
      height: 6px;
      background: linear-gradient(to right, #289500 0%, #289500 27.27%, #f7e400 27.27%, #f7e400 45.45%, #f85900 45.45%, #f85900 63.64%, #d8001d 63.64%, #d8001d 81.82%, #6b49c8 81.82%, #6b49c8 100%);
      border-radius: 3px;
      position: relative;
    ">
      <div id="uv-indicator" style="
        position: absolute;
        width: 3px;
        height: 12px;
        background: #00072d;
        top: -3px;
        border-radius: 2px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        transition: left 0.3s ease;
      "></div>
    </div>
    <div style="display: flex; justify-content: space-between; font-size: 0.65em; opacity: 0.8; margin-top: 2px;">
      <span>0</span>
      <span>11+</span>
    </div>
  </div>
  
  <small id="env-updated" style="opacity:0.7; font-size: 0.75em; display: block; text-align: right;">Updated: --</small>
</div>

<script>
  const aqiToken = "902f87a0a51e5839820aae018e6d08cebfdcd2b8";
  const city = "Kuala Lumpur";
  const lat = 3.139, lon = 101.687;

  async function updateWidget() {
    // Fetch AQI
    const aqiRes = await fetch(`https://api.waqi.info/feed/${city}/?token=${aqiToken}`);
    const aqiData = await aqiRes.json();
    // Fetch UV
    const uvRes = await fetch(`https://currentuvindex.com/api/v1/uvi?latitude=${lat}&longitude=${lon}`);
    const uvData = await uvRes.json();

    const aqiEl = document.getElementById("env-aqi");
    const aqiLevelEl = document.getElementById("env-aqi-level");
    const uvEl = document.getElementById("env-uv");
    const cityEl = document.getElementById("env-city");
    const updEl = document.getElementById("env-updated");

    if (aqiData.status === "ok") {
      const aqi = aqiData.data.aqi;
      aqiEl.textContent = aqi;
      const fullCityName = aqiData.data.city.name;
      cityEl.textContent = fullCityName;
      cityEl.setAttribute('title', fullCityName);
      
      // Determine AQI level and color
      let level, color;
      if (aqi <= 50) {
        level = "Good"; color = "#00e400";
      } else if (aqi <= 100) {
        level = "Moderate"; color = "#ffff00";
      } else if (aqi <= 150) {
        level = "Unhealthy for Sensitive"; color = "#ff7e00";
      } else if (aqi <= 200) {
        level = "Unhealthy"; color = "#ff0000";
      } else if (aqi <= 300) {
        level = "Very Unhealthy"; color = "#8f3f97";
      } else {
        level = "Hazardous"; color = "#7e0023";
      }
      
      aqiLevelEl.textContent = level;
      aqiLevelEl.style.background = color;
      aqiLevelEl.style.color = (aqi <= 100) ? "#000" : "#fff";
      
      // Update AQI indicator position (0-300+ scale)
      const aqiIndicator = document.getElementById('aqi-indicator');
      const aqiPosition = Math.min((aqi / 300) * 100, 100);
      aqiIndicator.style.left = `calc(${aqiPosition}% - 2px)`;
    } else {
      aqiEl.textContent = "N/A";
      aqiLevelEl.textContent = "N/A";
      aqiLevelEl.style.background = "#ccc";
      cityEl.textContent = city;
      cityEl.setAttribute('title', city);
    }

    if (uvData.ok) {
      const uvIndex = uvData.now.uvi;
      uvEl.textContent = `UV: ${uvIndex}`;
      
      // Update UV indicator position (0-11+ scale)
      const uvIndicator = document.getElementById('uv-indicator');
      const uvPosition = Math.min((uvIndex / 11) * 100, 100);
      uvIndicator.style.left = `calc(${uvPosition}% - 1.5px)`;
    } else {
      uvEl.textContent = "UV: N/A";
    }

    updEl.textContent = `Updated: ${new Date().toLocaleTimeString()}`;
  }

  updateWidget();
  setInterval(updateWidget, 30 * 60 * 1000); // refresh every 30 minutes
</script>
